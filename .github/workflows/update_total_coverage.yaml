name: update_total_coverage
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üìö Git Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0

      - name: üê£ Preparing Environment
        uses: ./.github/actions/init

      - name: üîô Get previous commit
        id: prev-commit
        run: |
          PREV_COMMIT=$(git rev-parse HEAD^)
          echo "PREV_COMMIT=$PREV_COMMIT" >> $GITHUB_ENV

      - name: üì¶ Install tools
        run: |
          dart pub global activate coverage

      - name: üìù Compute Git Diff
        id: compute_diff
        run: |
          LAST_PR_COMMIT_HASH=$(git log --merges -n 1 --format=%H)
          echo "LAST_PR_COMMIT_HASH=$LAST_PR_COMMIT_HASH" >> $GITHUB_ENV

      - name: üìù Preparing coverage report
        run: |
          melos exec --diff=${{ env.LAST_PR_COMMIT_HASH }} -c 1 --fail-fast --file-exists="coverage/lcov.info" -- \
            "\$MELOS_ROOT_PATH/scripts/combine_coverage.sh"

      - name: ü§∑ Check report existence
        id: check_files
        uses: andstor/file-existence-action@v1
        with:
          files: 'coverage_report/lcov.info'

      - name: Setup LCOV
        uses: hrishikesh-kadam/setup-lcov@v1

      - name: üìä Report code coverage
        uses: zgosalvez/github-actions-report-lcov@v3
        if: steps.check_files.outputs.files_exists == 'true'
        with:
          coverage-files: coverage_report/lcov.info
          artifact-name: code-coverage-report
          github-token: ${{ secrets.GITHUB_TOKEN }}
          update-comment: true

      - name: Upload artifact for deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: coverage_report/html

  deploy:
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
